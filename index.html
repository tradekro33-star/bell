<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BTC Multi-Timeframe Candles + RSI Alerts</title>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        body {
            font-family: Arial;
            margin: 0;
            background: #111;
            color: #fff;
        }
        #chart { height: 420px; }
        #rsiChart { height: 180px; }
        .container { padding: 15px; text-align: center; }
        button {
            padding: 8px 18px;
            margin: 5px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 6px;
        }
        .alert-box { margin-top: 15px; color: yellow; font-size: 18px; font-weight: bold; }
    </style>
</head>

<body>

<div class="container">
    <h2>BTC Chart + RSI-14 + Timeframes + Alerts</h2>

    <button onclick="loadCandles('5m')">5 Min</button>
    <button onclick="loadCandles('15m')">15 Min</button>
    <button onclick="loadCandles('1h')">1 Hour</button>

    <br><br>

    RSI High (&gt;): <input type="number" id="alertHigh" value="70">
    RSI Low (&lt;): <input type="number" id="alertLow" value="30">
    <button onclick="setAlerts()">Set RSI Alerts</button>

    <div id="alertMessage" class="alert-box"></div>

    <div id="chart"></div>
    <div id="rsiChart"></div>
</div>

<script>
    let alertHigh = 70;
    let alertLow = 30;

    const alertSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

    function setAlerts() {
        alertHigh = parseFloat(document.getElementById("alertHigh").value);
        alertLow = parseFloat(document.getElementById("alertLow").value);

        document.getElementById("alertMessage").innerHTML =
            "Alerts updated: RSI > " + alertHigh + " OR RSI < " + alertLow;
    }

    // --------------------- MAIN CHART ---------------------
    const chart = LightweightCharts.createChart(document.getElementById("chart"), {
        width: window.innerWidth - 40,
        height: 420,
        layout: { background: { color: '#111' }, textColor: '#fff' },
        grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } }
    });

    const candleSeries = chart.addCandlestickSeries();

    // --------------------- RSI CHART ---------------------
    const rsiChart = LightweightCharts.createChart(document.getElementById("rsiChart"), {
        width: window.innerWidth - 40,
        height: 180,
        layout: { background: { color: '#111' }, textColor: '#fff' },
        grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } }
    });

    const rsiSeries = rsiChart.addLineSeries({
        color: '#00bfff',
        lineWidth: 2
    });

    // --------------- CALCULATE RSI-14 ---------------
    function calculateRSI(closes, period = 14) {
        let rsi = [];
        let gains = 0, losses = 0;

        for (let i = 1; i <= period; i++) {
            let diff = closes[i] - closes[i - 1];
            if (diff >= 0) gains += diff;
            else losses -= diff;
        }

        gains /= period;
        losses /= period;

        rsi.push(100 - (100 / (1 + gains / losses)));

        for (let i = period + 1; i < closes.length; i++) {
            let diff = closes[i] - closes[i - 1];
            let gain = diff > 0 ? diff : 0;
            let loss = diff < 0 ? -diff : 0;

            gains = (gains * (period - 1) + gain) / period;
            losses = (losses * (period - 1) + loss) / period;

            rsi.push(100 - (100 / (1 + gains / losses)));
        }

        return rsi;
    }

    // -------------------  CUSTOM ALERTS -------------------
    function checkRsiAlerts(rsi) {
        if (rsi > alertHigh) {
            document.getElementById("alertMessage").innerHTML =
                "‚ö†Ô∏è RSI Overbought Alert (" + rsi.toFixed(2) + ")";
            alertSound.play();
        }

        if (rsi < alertLow) {
            document.getElementById("alertMessage").innerHTML =
                "‚ö†Ô∏è RSI Oversold Alert (" + rsi.toFixed(2) + ")";
            alertSound.play();
        }
    }

    function checkRsiGreenCandleAlert(rsi, candle) {
        if (rsi <= 60 && candle.close > candle.open) {
            document.getElementById("alertMessage").innerHTML =
                "üü¢ RSI ‚â§ 60 + GREEN Candle (RSI: " + rsi.toFixed(2) + ")";
            alertSound.play();
        }
    }

    // ------------------- LOAD CHART DATA -------------------
    async function loadCandles(interval) {
        const url =
            `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=500`;

        const response = await fetch(url);
        const data = await response.json();

        const candles = data.map(c => ({
            time: c[0] / 1000,
            open: parseFloat(c[1]),
            high: parseFloat(c[2]),
            low: parseFloat(c[3]),
            close: parseFloat(c[4])
        }));

        candleSeries.setData(candles);

        const closes = candles.map(c => c.close);
        const rsiValues = calculateRSI(closes, 14);

        const rsiPlot = candles.slice(14).map((c, i) => ({
            time: c.time,
            value: rsiValues[i]
        }));

        rsiSeries.setData(rsiPlot);

        const lastCandle = candles[candles.length - 1];
        const lastRSI = rsiValues[rsiValues.length - 1];

        checkRsiAlerts(lastRSI);
        checkRsiGreenCandleAlert(lastRSI, lastCandle);
    }

    loadCandles("5m");

    window.addEventListener("resize", () => {
        chart.applyOptions({ width: window.innerWidth - 40 });
        rsiChart.applyOptions({ width: window.innerWidth - 40 });
    });
</script>

</body>
</html>
